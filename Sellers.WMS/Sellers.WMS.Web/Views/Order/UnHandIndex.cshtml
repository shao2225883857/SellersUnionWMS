@model IEnumerable<Sellers.WMS.Domain.OrderType>
@{
    ViewBag.Title = "Index";
}
<script src="~/Scripts/EasyUI/datagrid-detailview.js"></script>
<body class="easyui-layout">
    <script language="javascript" type="text/javascript">
        var grid;
        $(function () {
            //$('#dlgLogistics').dialog('close');
            grid = $('#dg').datagrid({
                url: '@Url.Action("List", "Order")',
                idField: 'Id',
                iconCls: 'icon-view',
                height: 420,
                width: function () { return document.body.clientWidth * 0.9 },
                nowrap: true,
                view: detailview,
                animate: true,
                resizable: true,
                pagination: true,
                pageNumber: 1,
                pageSize: 100,
                pageList: [50, 100, 200],
                rownumbers: true,
                columns: [[
                    { title: '主键', field: 'Id', width: 100, sortable: true, checkbox: true },
                    { title: '订单编号', field: 'OrderNo', width: 150, sortable: true, align: 'center', formatter: showOrderNo },
                   // { title: '外部编号', field: 'OrderExNo', width: 100, sortable: true, align: 'center' },
                    { title: '订单状态', field: 'Status', width: 150, sortable: true, align: 'center' },
                    //{ title: '是否打印', field: 'IsPrint', width: 100, sortable: true,align: 'center' },
                    //{ title: '合并订单', field: 'IsMerger', width: 100, sortable: true,align: 'center' },
                    //{ title: '拆分订单', field: 'IsSplit', width: 100, sortable: true,align: 'center' },
                    //{ title: '缺货订单', field: 'IsOutOfStock', width: 100, sortable: true,align: 'center' },
                    //{ title: '重发订单', field: 'IsRepeat', width: 100, sortable: true,align: 'center' },
                    { title: '货币', field: 'CurrencyCode', width: 100, sortable: true, align: 'center', formatter: showAmount },
                  //{ title: '流水交易号', field: 'TId', width: 100, sortable: true, align: 'center' },
                    { title: '买家', field: 'BuyerName', width: 150, sortable: true, align: 'center', formatter: showBuyer },
                    //{ title: '买家邮箱', field: 'BuyerEmail', width: 100, sortable: true,align: 'center' },
                    //{ title: '买家Id', field: 'BuyerId', width: 100, sortable: true,align: 'center' },
                    //{ title: '买家留言', field: 'BuyerMemo', width: 100, sortable: true, align: 'center' },
                    //{ title: '商家留言', field: 'SellerMemo', width: 100, sortable: true, align: 'center' },
                    { title: '发货方式', field: 'LogisticMode', width: 150, sortable: true, align: 'center' },
                    { title: '国家', field: 'Country', width: 150, sortable: true, align: 'center' },
                    //{ title: '地址Id', field: 'AddressId', width: 100, sortable: true, align: 'center' },
                   // { title: '重量', field: 'Weight', width: 100, sortable: true, align: 'center' },
                    { title: '时间', field: 'GenerateOn', width: 200, sortable: true, align: 'center', formatter: showDatetime },
                    { title: '账户', field: 'Account', width: 200, sortable: true, align: 'center', formatter: showAccount }
                ]],
                toolbar: '#toolbar',
                onLoadSuccess: function (data) {
                    if (data.rows.length > 0) {
                        $('#dg').datagrid("selectRow", 0);
                    }
                },
                rowStyler: function (index, row, css) {
                    if (row.Id != "") {
                        return 'font-weight:bold;';
                    }
                },
                detailFormatter: function (index, row) {
                    var html = "<table width='1000px'>";
                    for (var i = 0; i < row.ProductList.length; i++) {
                        html += '<tr>'
                            + '<td width="100px" ><img src="' + row.ProductList[i]["ImgUrl"] + '" width="64px" height="64px"/>' + "</td>"
                            + "<td  width='100px'>ExSKU：" + getExSKUUrl(row.ProductList[i]["ExSKU"], row.Platform) + "</td>"
                            + "<td width='100px'>SKU：" + row.ProductList[i]["SKU"] + "</td>"
                            + "<td width='100px'>Qty：" + row.ProductList[i]["Qty"] + "</td>"
                            + "<td width='200px'>规格：" + row.ProductList[i]["Standard"] + "</td>"
                            + "<td width='200px'>状态：" + getProducts(row.ProductList[i]["Status"]) + "</td>"
                            + "<td width='200'>描述：" + row.ProductList[i]["Remark"] + "</td>"
                            + '</tr>';
                    }
                    html += '<tr><td colspan="8"><b>买家留言：</b>' + row.BuyerMemo + '</td></tr>';
                    html += "</table>";

                    return html;
                }
            });
            $('#txtPlatform').combobox({
                url: '@Url.Action("GetSearchOptions", "DataDictionaryDetail")/SalePlatform',
                valueField: 'DicValue',
                textField: 'FullName',
                required: true,
                width: 150,
                panelHeight: 'auto',
                onChange: changePlatform,
                onLoadSuccess: function () {
                    var val = $(this).combobox("getData");
                    for (var item in val[0]) {
                        if (item == 'DicValue') {
                            $(this).combobox("select", val[0][item]);
                        }
                    }
                }
            });

            $('#txtStatus').combobox({
                url: '@Url.Action("GetSearchOptions", "DataDictionaryDetail")/OrderStatus',
                valueField: 'DicValue',
                textField: 'FullName',
                panelHeight: 'auto',
                width: 100
            });
            $('#txtLogisticMode').combobox({
                url: '@Url.Action("GetSearchOptions", "DataDictionaryDetail")/LogisticsMode',
                valueField: 'DicValue',
                textField: 'FullName',
                panelHeight: 'auto',
                width: 100
            });
            $('#txtLogistics').combobox({
                url: '@Url.Action("GetOptions", "DataDictionaryDetail")/LogisticsMode',
                valueField: 'DicValue',
                textField: 'FullName',
                panelHeight: 'auto',
                width: 150
            });
            checkComboxInit("txtIsPrint");
            checkComboxInit("txtIsMerger");
            //checkComboxInit("txtIsSplit");
            checkComboxInit("txtIsOutOfStock");
            checkComboxInit("txtIsRepeat");
            // checkComboxInit("txtIsPrint");
            $("#txtGenerateOn,#txtGenerateOn2").datetimebox({

            });

        });

        function checkComboxInit(control) {
            $('#' + control).combobox({
                valueField: 0,
                textField: 1,
                panelHeight: 'auto',
                data: checksall,
                width: 100,
                onLoadSuccess: function () {
                    $(this).combobox("select", 0);
                }
            });
        }
       

        function changePlatform(n, o) {
            comboboxInit('/Account/GetAccountListByPlatform/', "id=" + n + "&t=1", 'txtAccount', 'Id', 'AccountName');
        }

        function refreshClick() {
            grid.datagrid("reload");
        }

        function getProducts(s) {
            if (s == 0)
                return "正常";
            if (s == 1)
                return "缺货";
            if (s == 2)
                return "停产";
            if (s == 3)
                return "正常--占用";
        }

        function getExSKUUrl(s, p) {
            if (p == "Aliexpress")
                return '<a href="http://www.aliexpress.com/item/sells/' + s + '.html" target="_blank">' + s + '</a>';
            else
                return s;
        }
        function showBuyer(v, r, i) {
            return v + '<br />' + r.BuyerEmail;
        }
        function showAmount(v, r, i) {
            return v + ":" + r.Amount;
        }

        function showOrderNo(v, r, i) {
            return v + '<br />' + r.OrderExNo;
        }

        function showAccount(v, r, i) {
            return r.Platform + '<br />' + v;
        }
        function showDatetime(v, r, i) {
            return '下：' + getDateTime(v) + '<br />同：' + getDateTime(r.CreateOn);
        }

        function addClick() {
            parent.$.modalDialog({
                title: '添加数据',
                width: 650,
                height: 350,
                href: '@Url.Action("Create", "Order")',
                buttons: [{
                    text: '添加',
                    handler: function () {
                        parent.$.modalDialog.penner_grid = grid;//将grid绑定到公共变量中
                        var f = parent.$.modalDialog.handler.find('#form');
                        f.submit();
                    }
                }]
            });
        }


        //编辑框
        function editClick() {
            var id = getselectedRow(grid);
            if (id) {
                parent.$.modalDialog({
                    title: '编辑数据',
                    width: 650,
                    height: 300,
                    href: '@Url.Action("Edit", "Order")/' + id,
                    buttons: [{
                        text: '修改',
                        handler: function () {
                            parent.$.modalDialog.penner_grid = grid;//将grid绑定到公共变量中
                            var f = parent.$.modalDialog.handler.find('#form');
                            f.submit();
                        }
                    }]
                });
            }
        }

        function printOrder() {

            var ids = getselectedRows(grid, 'OrderNo');
            if (ids.length > 0)
                jQuery.ajax({
                    url: "/Home/PostData",
                    type: "post",
                    data: "ids=" + ids.join(','),
                    success: function (sss) {
                        window.open('/Home/PrintSetup/');
                    }
                });
        }

        function setLogistics() {
            var ids = getselectedRows(grid, 'Id');
            if (ids.length > 0)
                jQuery.ajax({
                    url: "/Order/SetLogistics",
                    type: "post",
                    data: "ids=" + ids.join(',') + "&l=" + $("#txtLogistics").combobox("getValue"),
                    success: function (res) {
                        if(res.IsSuccess) {
                            refreshClick();
                            $('#dlgLogistics').window('close');
                            showSuccessMessage();
                        }
                    }
                });
        }
        
       
       

        function showSetLogistics() {
            var ids = getselectedRows(grid, 'Id');
            if (ids.length > 0)
                $('#dlgLogistics').window('open');
        }



        function doSearch() {
            var search = "";
            if ($('#txtOrderNo').val().length != 0) {
                search += 'OrderNo&' + $('#txtOrderNo').val() + '^';
                search += 'OrderExNo&' + $('#txtOrderExNo').val() + '^';
            }
            if ($('#txtStatus').combobox("getValue") != 0)
                search += 'Status&' + $('#txtStatus').combobox("getValue") + '^';
            if ($('#txtIsPrint').combobox("getValue") != 0)
                search += 'IsPrint&' + $('#txtIsPrint').val() + '^';
            if ($('#txtIsMerger').combobox("getValue") != 0)
                search += 'IsMerger&' + $('#txtIsMerger').val() + '^';
            //if ($('#txtIsSplit').combobox("getValue") != 0)
            //    search += 'IsSplit&' + $('#txtIsSplit').combobox("getValue") + '^';
            if ($('#txtIsOutOfStock').combobox("getValue") != 0)
                search += 'IsOutOfStock&' + $('#txtIsOutOfStock').combobox("getValue") + '^';
            if ($('#txtIsRepeat').combobox("getValue") != 0)
                search += 'IsRepeat&' + $('#txtIsRepeat').combobox("getValue") + '^';

            if ($('#txtBuyerName').val().length != 0) {
                search += 'BuyerName&' + $('#txtBuyerName').val() + '^';
                search += 'BuyerEmail&' + $('#txtBuyerEmail').val() + '^';
            }
            if ($('#txtLogisticMode').combobox("getValue") != 0)
                search += 'LogisticMode&' + $('#txtLogisticMode').combobox("getValue") + '^';
            if ($('#txtCountry').val().length != 0)
                search += 'Country&' + $('#txtCountry').val() + '^';
            search += 'GenerateOn_st&' + $('#txtGenerateOn').combobox("getValue") + '^';
            search += 'GenerateOn_et&' + $('#txtGenerateOn2').combobox("getValue") + '^';
            if ($('#txtAccount').combobox("getValue") != 0)
                search += 'Account&' + $('#txtAccount').combobox("getValue") + '^';
            if ($('#txtPlatform').combobox("getValue") != 0)
                search += 'Platform&' + $('#txtPlatform').combobox("getValue") + '^';
            grid.datagrid("load", {
                search: search
            });
        }
</script>
    <div region="center">
        <fieldset>
            <legend>数据查询</legend>
            <table border="0">
                <tr>

                    <td class='z-searchlable'>平台:</td>
                    <td>
                        <input type='text' id='txtPlatform' /></td>
                    <td class='z-searchlable'>账户:</td>
                    <td>
                        <input type='text' id='txtAccount' /></td>
                    <td class='z-searchlable'>状态:</td>
                    <td>
                        <input type='text' id='txtStatus' /></td>
                    <td class='z-searchlable'>打印:</td>
                    <td>
                        <input type='text' id='txtIsPrint' /></td>
                    <td class='z-searchlable'>缺货:</td>
                    <td>
                        <input type='text' id='txtIsOutOfStock' /></td>
                </tr>
                <tr>
                    <td class='z-searchlable'>重发:</td>
                    <td>
                        <input type='text' id='txtIsRepeat' /></td>
                    <td class='z-searchlable'>合并:</td>
                    <td>
                        <input type='text' id='txtIsMerger' /></td>
                    <td class='z-searchlable'>订单编号:</td>
                    <td>
                        <input type='text' id='txtOrderNo' /></td>
                    <td class='z-searchlable'>交易号:</td>
                    <td>
                        <input type='text' id='txtTId' /></td>
                    <td class='z-searchlable'>买家:</td>
                    <td>
                        <input type='text' id='txtBuyerName' /></td>
                </tr>
                <tr>
                    <td class='z-searchlable'>发货方式:</td>
                    <td>
                        <input type='text' id='txtLogisticMode' /></td>
                    <td class='z-searchlable'>国家:</td>
                    <td>
                        <input type='text' id='txtCountry' /></td>
                    <td class='z-searchlable'>付款时间:</td>
                    <td colspan="4">
                        <input type='text' id='txtGenerateOn' />
                        至
                        <input type='text' id='txtGenerateOn2' /></td>
                    <td colspan="2"><a href='#' class='easyui-linkbutton' iconcls='icon-search' onclick='doSearch();'>查询</a></td>
                </tr>
            </table>
        </fieldset>
        <div id="toolbar">
            @Html.Raw(ViewData["toolbarButtons"])
        </div>
        <table id="dg">
        </table>
        <div id="dropdown" style="width: 200px; display: none;">
            <div data-options="iconCls:'icon-ext-xls'" data-bind="click: downloadClick1">Excel2003表格所有页</div>
            <div data-options="iconCls:'icon-ext-xls'" data-bind="click: downloadClick2">Excel2003表格指定页</div>
            <div data-options="iconCls:'icon-ext-rar'" data-bind="click: downloadClick3">Excel2003压缩zip</div>
            <div data-options="iconCls:'icon-page_excel'" data-bind="click: downloadClick4">Excel2007/2010</div>
            <div data-options="iconCls:'icon-ext-pdf'" data-bind="click: downloadClick5">PDF</div>
            <div data-options="iconCls:'icon-ext-doc'" data-bind="click: downloadClick6">Word</div>
        </div>
        <div id="dlgLogistics" class="easyui-window" title="设置发货方式" data-options="modal:true,closed:true,iconCls:'icon-save'" style="width:350px;height:150px;padding:10px;">
            <div style="text-align: center; line-height: 80px;">
                <table>
                    <tr>
                        <td>发货方式：</td>
                        <td><input type="text" id="txtLogistics" /></td>
                        <td>&nbsp;&nbsp;&nbsp;&nbsp;<a href='#' class='easyui-linkbutton' onclick='setLogistics();'>确定</a></td>
                    </tr>
                </table>

            </div>
            
        </div>
    </div>
            
</body>
